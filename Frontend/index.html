<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio de Profesionales de la Salud</title>
    <link href="https://cdn.jsdelivr.net/npm/[email¬†protected]/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .professional-card {
            border-left: 4px solid #28a745;
        }
        .appointment-card {
            border-left: 4px solid #007bff;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .hidden {
            display: none;
        }
        .navbar-brand {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">üè• Directorio de Salud</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-5">Directorio de Profesionales de la Salud</h1>
                <p class="lead text-muted">Conectamos pacientes con los mejores profesionales m√©dicos en M√©xico</p>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertContainer"></div>

        <div class="row">
            <!-- Columna Izquierda: Gesti√≥n de Usuarios -->
            <div class="col-md-4">
                <!-- Registro de Usuario -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üë§ Registro de Usuario</h5>
                    </div>
                    <div class="card-body">
                        <form id="userForm">
                            <div class="mb-3">
                                <label for="nombre" class="form-label">Nombre completo *</label>
                                <input type="text" class="form-control" id="nombre" required 
                                       placeholder="Ingrese su nombre completo">
                            </div>
                            <div class="mb-3">
                                <label for="correo" class="form-label">Correo electr√≥nico *</label>
                                <input type="email" class="form-control" id="correo" required 
                                       placeholder="ejemplo@correo.com">
                            </div>
                            <div class="mb-3">
                                <label for="contrasena" class="form-label">Contrase√±a *</label>
                                <input type="password" class="form-control" id="contrasena" required 
                                       placeholder="M√≠nimo 6 caracteres">
                            </div>
                            <div class="mb-3">
                                <label for="telefono" class="form-label">Tel√©fono</label>
                                <input type="tel" class="form-control" id="telefono" 
                                       placeholder="+525512345678">
                            </div>
                            <button type="submit" class="btn btn-success w-100" id="btnRegister">
                                <span id="btnRegisterText">Registrarse</span>
                                <div id="btnRegisterSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Login -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üîê Iniciar Sesi√≥n</h5>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="loginCorreo" class="form-label">Correo electr√≥nico</label>
                                <input type="email" class="form-control" id="loginCorreo" required>
                            </div>
                            <div class="mb-3">
                                <label for="loginContrasena" class="form-label">Contrase√±a</label>
                                <input type="password" class="form-control" id="loginContrasena" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Iniciar Sesi√≥n</button>
                        </form>
                    </div>
                </div>

                <!-- Informaci√≥n del Usuario -->
                <div class="card hidden" id="userInfoCard">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üëã Usuario Conectado</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Nombre:</strong> <span id="userInfoName"></span></p>
                        <p><strong>Email:</strong> <span id="userInfoEmail"></span></p>
                        <button class="btn btn-outline-danger btn-sm w-100" id="btnLogout">Cerrar Sesi√≥n</button>
                    </div>
                </div>
            </div>

            <!-- Columna Central: B√∫squeda de Profesionales -->
            <div class="col-md-4">
                <!-- B√∫squeda de Profesionales -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">üîç Buscar Profesionales</h5>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="mb-3">
                                <label for="especialidad" class="form-label">Especialidad</label>
                                <input type="text" class="form-control" id="especialidad" 
                                       placeholder="Ej: Cardiolog√≠a, Pediatr√≠a...">
                            </div>
                            <div class="mb-3">
                                <label for="ubicacion" class="form-label">Ubicaci√≥n</label>
                                <input type="text" class="form-control" id="ubicacion" 
                                       placeholder="Ej: Ciudad de M√©xico, Guadalajara...">
                            </div>
                            <div class="mb-3">
                                <label for="nombreProfesional" class="form-label">Nombre del profesional</label>
                                <input type="text" class="form-control" id="nombreProfesional" 
                                       placeholder="Ej: Dr. Juan P√©rez">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Filtros de Seguro</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sinSeguro">
                                    <label class="form-check-label" for="sinSeguro">
                                        Mostrar solo profesionales sin seguro (privados)
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-warning w-100">Buscar Profesionales</button>
                        </form>
                    </div>
                </div>

                <!-- Resultados de B√∫squeda -->
                <div class="card hidden" id="resultsCard">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üìã Profesionales Encontrados</h5>
                    </div>
                    <div class="card-body">
                        <div id="searchResults"></div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Gesti√≥n de Citas -->
            <div class="col-md-4">
                <!-- Agendar Cita -->
                <div class="card hidden" id="appointmentCard">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üìÖ Agendar Cita M√©dica</h5>
                    </div>
                    <div class="card-body">
                        <form id="appointmentForm">
                            <input type="hidden" id="profesionalId">
                            <div class="mb-3">
                                <label class="form-label">Profesional seleccionado:</label>
                                <p class="form-control-static fw-bold" id="profesionalNombre"></p>
                            </div>
                            <div class="mb-3">
                                <label for="fechaHora" class="form-label">Fecha y Hora de la cita *</label>
                                <input type="datetime-local" class="form-control" id="fechaHora" required>
                            </div>
                            <div class="mb-3">
                                <label for="motivo" class="form-label">Motivo de la consulta</label>
                                <textarea class="form-control" id="motivo" rows="3" 
                                          placeholder="Describa el motivo de su consulta"></textarea>
                            </div>
                            <button type="submit" class="btn btn-info w-100" id="btnAgendar">
                                <span id="btnAgendarText">Agendar Cita</span>
                                <div id="btnAgendarSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </button>
                            <button type="button" class="btn btn-secondary w-100 mt-2" id="cancelAppointment">
                                Cancelar
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Citas Agendadas -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìù Citas Agendadas</h5>
                    </div>
                    <div class="card-body">
                        <div id="loadingCitas" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando citas...</span>
                            </div>
                            <p class="mt-2">Cargando citas...</p>
                        </div>
                        <div id="citasList"></div>
                        <div id="emptyCitas" class="text-center d-none">
                            <p class="text-muted">No hay citas agendadas</p>
                            <small class="text-muted">Busque profesionales y agende su primera cita</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n T√©cnica -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0">üîß Informaci√≥n T√©cnica - Integraci√≥n Frontend/Backend</h6>
                    </div>
                    <div class="card-body">
                        <small class="text-muted">
                            <strong>API REST:</strong> Especificaci√≥n OpenAPI YAML | 
                            <strong>Backend:</strong> Node.js + Express + MySQL | 
                            <strong>Frontend:</strong> HTML + Bootstrap + JavaScript |
                            <strong>Autenticaci√≥n:</strong> JWT Tokens
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/[email¬†protected]/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/[email¬†protected]/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // Configuraci√≥n
        const API_BASE_URL = '/api';
        let currentUser = null;
        let token = null;

        // Elementos DOM
        const alertContainer = document.getElementById('alertContainer');
        const userInfoCard = document.getElementById('userInfoCard');
        const resultsCard = document.getElementById('resultsCard');
        const appointmentCard = document.getElementById('appointmentCard');

        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Mostrar loading en bot√≥n
        function setLoading(button, isLoading, loadingText = 'Procesando...') {
            const btnText = button.querySelector('span');
            const btnSpinner = button.querySelector('.spinner-border');
            
            if (isLoading) {
                btnText.textContent = loadingText;
                btnSpinner.classList.remove('d-none');
                button.disabled = true;
            } else {
                // Restaurar texto original basado en el ID del bot√≥n
                if (button.id === 'btnRegister') {
                    btnText.textContent = 'Registrarse';
                } else if (button.id === 'btnAgendar') {
                    btnText.textContent = 'Agendar Cita';
                }
                btnSpinner.classList.add('d-none');
                button.disabled = false;
            }
        }

        // ==================== GESTI√ìN DE USUARIOS ====================

        // Registro de usuario
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('btnRegister');
            
            const userData = {
                nombre: document.getElementById('nombre').value,
                correo: document.getElementById('correo').value,
                contrasena: document.getElementById('contrasena').value,
                telefono: document.getElementById('telefono').value || null
            };
            
            try {
                setLoading(submitButton, true, 'Registrando...');
                
                const response = await axios.post(`${API_BASE_URL}/usuarios`, userData);
                
                showAlert('‚úÖ Usuario registrado exitosamente. Ahora puede iniciar sesi√≥n.', 'success');
                document.getElementById('userForm').reset();
                
            } catch (error) {
                console.error('Error registrando usuario:', error);
                const errorMessage = error.response?.data?.mensaje || 'Error al registrar usuario';
                showAlert(`‚ùå ${errorMessage}`, 'danger');
            } finally {
                setLoading(submitButton, false);
            }
        });

        // Login de usuario
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const loginData = {
                correo: document.getElementById('loginCorreo').value,
                contrasena: document.getElementById('loginContrasena').value
            };
            
            try {
                const response = await axios.post(`${API_BASE_URL}/auth/login`, loginData);
                
                currentUser = response.data.usuario;
                token = response.data.token;
                
                // Guardar en localStorage
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify(currentUser));
                
                showAlert('‚úÖ Inicio de sesi√≥n exitoso', 'success');
                updateUserInterface();
                loadCitas();
                
            } catch (error) {
                console.error('Error en login:', error);
                const errorMessage = error.response?.data?.mensaje || 'Error en inicio de sesi√≥n';
                showAlert(`‚ùå ${errorMessage}`, 'danger');
            }
        });

        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => {
            currentUser = null;
            token = null;
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            updateUserInterface();
            showAlert('üëã Sesi√≥n cerrada correctamente', 'info');
        });

        // Actualizar interfaz de usuario
        function updateUserInterface() {
            if (currentUser && token) {
                userInfoCard.classList.remove('hidden');
                document.getElementById('userInfoName').textContent = currentUser.nombre;
                document.getElementById('userInfoEmail').textContent = currentUser.correo;
                document.getElementById('loginForm').reset();
            } else {
                userInfoCard.classList.add('hidden');
            }
        }

        // ==================== B√öSQUEDA DE PROFESIONALES ====================

        // B√∫squeda de profesionales
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const searchParams = {
                especialidad: document.getElementById('especialidad').value,
                ubicacion: document.getElementById('ubicacion').value,
                nombre: document.getElementById('nombreProfesional').value,
                sinSeguro: document.getElementById('sinSeguro').checked ? 'true' : undefined
            };
            
            // Eliminar par√°metros vac√≠os
            Object.keys(searchParams).forEach(key => {
                if (!searchParams[key]) delete searchParams[key];
            });
            
            try {
                const response = await axios.get(`${API_BASE_URL}/profesionales`, {
                    params: searchParams
                });
                
                displayProfessionals(response.data);
                
            } catch (error) {
                console.error('Error buscando profesionales:', error);
                if (error.response?.status === 404) {
                    showAlert('‚ÑπÔ∏è ' + error.response.data.mensaje, 'info');
                } else {
                    showAlert('‚ùå Error buscando profesionales', 'danger');
                }
                resultsCard.classList.add('hidden');
            }
        });

        // Mostrar resultados de profesionales
        function displayProfessionals(professionals) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (professionals.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-info">
                        No se encontraron profesionales con los criterios especificados.
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = professionals.map(prof => `
                    <div class="card professional-card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">${prof.nombre}</h6>
                            <p class="card-text mb-1">
                                <strong>Especialidad:</strong> ${prof.especialidad}<br>
                                <strong>Ubicaci√≥n:</strong> ${prof.ubicacion}<br>
                                <strong>Contacto:</strong> ${prof.contacto || 'No especificado'}
                            </p>
                            <p class="card-text">
                                <strong>Seguros aceptados:</strong><br>
                                ${prof.segurosAceptados.length > 0 
                                    ? prof.segurosAceptados.map(s => 
                                        `<span class="badge bg-secondary me-1">${s.nombre}</span>`
                                      ).join('')
                                    : '<span class="badge bg-warning">Solo consulta privada</span>'
                                }
                            </p>
                            <button class="btn btn-primary btn-sm" onclick="showAppointmentForm(${prof.id}, '${prof.nombre}')">
                                Agendar Cita
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsCard.classList.remove('hidden');
        }

        // ==================== GESTI√ìN DE CITAS ====================

        // Mostrar formulario de cita
        window.showAppointmentForm = function(profesionalId, profesionalNombre) {
            if (!currentUser) {
                showAlert('‚ö†Ô∏è Debe iniciar sesi√≥n para agendar una cita', 'warning');
                return;
            }
            
            document.getElementById('profesionalId').value = profesionalId;
            document.getElementById('profesionalNombre').textContent = profesionalNombre;
            appointmentCard.classList.remove('hidden');
        };

        // Agendar cita
        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('btnAgendar');
            
            const appointmentData = {
                usuarioId: currentUser.id,
                profesionalId: parseInt(document.getElementById('profesionalId').value),
                fechaHora: document.getElementById('fechaHora').value.replace('T', ' ') + ':00',
                motivo: document.getElementById('motivo').value || null
            };
            
            try {
                setLoading(submitButton, true, 'Agendando...');
                
                const response = await axios.post(`${API_BASE_URL}/citas`, appointmentData);
                
                showAlert('‚úÖ Cita agendada exitosamente', 'success');
                document.getElementById('appointmentForm').reset();
                appointmentCard.classList.add('hidden');
                loadCitas(); // Recargar lista de citas
                
            } catch (error) {
                console.error('Error agendando cita:', error);
                const errorMessage = error.response?.data?.mensaje || 'Error al agendar cita';
                showAlert(`‚ùå ${errorMessage}`, 'danger');
            } finally {
                setLoading(submitButton, false);
            }
        });

        // Cancelar agendamiento
        document.getElementById('cancelAppointment').addEventListener('click', () => {
            document.getElementById('appointmentForm').reset();
            appointmentCard.classList.add('hidden');
        });

        // Cargar y mostrar citas
        async function loadCitas() {
            const loadingElement = document.getElementById('loadingCitas');
            const citasList = document.getElementById('citasList');
            const emptyElement = document.getElementById('emptyCitas');
            
            try {
                loadingElement.classList.remove('d-none');
                citasList.classList.add('d-none');
                emptyElement.classList.add('d-none');
                
                const response = await axios.get(`${API_BASE_URL}/citas?limit=10`);
                
                if (response.data.citas.length > 0) {
                    displayCitas(response.data.citas);
                } else {
                    showEmptyCitas();
                }
                
            } catch (error) {
                console.error('Error cargando citas:', error);
                showEmptyCitas();
            } finally {
                loadingElement.classList.add('d-none');
            }
        }

        function displayCitas(citas) {
            const citasList = document.getElementById('citasList');
            const emptyElement = document.getElementById('emptyCitas');
            
            citasList.innerHTML = citas.map(cita => `
                <div class="card appointment-card mb-2">
                    <div class="card-body">
                        <h6 class="card-title">Cita con ${cita.profesional.nombre}</h6>
                        <p class="card-text mb-1">
                            <strong>Fecha:</strong> ${new Date(cita.fechaHora).toLocaleString('es-MX')}<br>
                            <strong>Paciente:</strong> ${cita.usuario.nombre}<br>
                            ${cita.motivo ? `<strong>Motivo:</strong> ${cita.motivo}` : ''}
                        </p>
                    </div>
                </div>
            `).join('');
            
            citasList.classList.remove('d-none');
            emptyElement.classList.add('d-none');
        }

        function showEmptyCitas() {
            const citasList = document.getElementById('citasList');
            const emptyElement = document.getElementById('emptyCitas');
            
            citasList.classList.add('d-none');
            emptyElement.classList.remove('d-none');
        }

        // ==================== INICIALIZACI√ìN ====================

        // Verificar sesi√≥n existente al cargar
        function checkExistingSession() {
            const savedToken = localStorage.getItem('token');
            const savedUser = localStorage.getItem('user');
            
            if (savedToken && savedUser) {
                token = savedToken;
                currentUser = JSON.parse(savedUser);
                updateUserInterface();
                loadCitas();
            }
        }

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            checkExistingSession();
            loadCitas();
            showAlert('üöÄ Directorio de Salud cargado. Use el formulario de registro o inicio de sesi√≥n para comenzar.', 'info');
        });
    </script>
</body>
</html>